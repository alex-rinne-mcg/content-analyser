name: Update N8N Workflow

on:
  push:
    paths:
      - 'zzuper-meta-analysis-workflow.json'
    branches:
      - main

jobs:
  update-n8n:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Update N8N Workflow
        env:
          N8N_API_KEY: ${{ secrets.N8N_API_KEY }}
          N8N_BASE_URL: ${{ secrets.N8N_BASE_URL }}
          N8N_WORKFLOW_ID: ${{ secrets.N8N_WORKFLOW_ID }}
        run: |
          echo "Updating N8N workflow..."
          
          # Check if secrets are set
          if [ -z "$N8N_API_KEY" ]; then
            echo "❌ Error: N8N_API_KEY secret is not set"
            exit 1
          fi
          if [ -z "$N8N_BASE_URL" ]; then
            echo "❌ Error: N8N_BASE_URL secret is not set"
            exit 1
          fi
          if [ -z "$N8N_WORKFLOW_ID" ]; then
            echo "❌ Error: N8N_WORKFLOW_ID secret is not set"
            exit 1
          fi
          
          # Check if workflow file exists
          if [ ! -f "zzuper-meta-analysis-workflow.json" ]; then
            echo "❌ Error: zzuper-meta-analysis-workflow.json not found"
            exit 1
          fi
          
          # Read workflow JSON and filter to only allowed fields for N8N API
          # N8N API only accepts: name, nodes, connections, settings, staticData, tags
          # It does NOT accept: id, active, createdAt, updatedAt, versionId, etc.
          WORKFLOW_JSON=$(cat zzuper-meta-analysis-workflow.json | jq '{
            name: .name,
            nodes: .nodes,
            connections: .connections,
            settings: .settings,
            staticData: .staticData,
            tags: .tags
          }')
          
          # Update workflow via N8N API
          echo "Sending request to: ${N8N_BASE_URL}/api/v1/workflows/${N8N_WORKFLOW_ID}"
          RESPONSE=$(curl -s -w "\n%{http_code}" -X PUT \
            -H "X-N8N-API-KEY: ${N8N_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "${WORKFLOW_JSON}" \
            "${N8N_BASE_URL}/api/v1/workflows/${N8N_WORKFLOW_ID}" 2>&1)
          
          # Check if curl command succeeded
          CURL_EXIT_CODE=$?
          if [ $CURL_EXIT_CODE -ne 0 ]; then
            echo "❌ Curl command failed with exit code: $CURL_EXIT_CODE"
            echo "Response: $RESPONSE"
            exit 1
          fi
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          if [ "$HTTP_CODE" -eq 200 ] || [ "$HTTP_CODE" -eq 201 ]; then
            echo "✅ Successfully updated N8N workflow"
            echo "$BODY"
          else
            echo "❌ Failed to update N8N workflow"
            echo "HTTP Code: $HTTP_CODE"
            echo "Response: $BODY"
            exit 1
          fi

